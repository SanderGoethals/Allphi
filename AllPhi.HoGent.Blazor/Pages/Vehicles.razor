@page "/vehicles"

@using AllPhi.HoGent.Blazor.Components
@using AllPhi.HoGent.Blazor.Services
@using AllPhi.HoGent.Blazor.Dto

@inject IDriverServices _driverService
@inject IVehicleServices _vehicleService
@inject IDriverVehicleServices _driverVehicleService

<PageTitle>Vehicles</PageTitle>

@if (_isLoading)
{
    <LoadingSpinner IsLoading="@_isLoading" />
}

@code {
    private VehicleListDto? _vehicleListDto;
    private DriverListDto? _driverListDto;

    private VehicleDto _selectedVehicleDto = new();
    private List<DriverVehicleDto> _driverVehicleDtos = new();
    private List<DriverDto> _checkedDriver = new();

    private bool _vehicleAdded = false;
    private bool _vehicleUpdated = false;
    private bool _vehicleDeleted = false;

    private bool _showSendConfirmation = false;
    private bool _error = false;
    private bool _addNewFuelCard = false;
    private bool _selectedVehicle = false;

    private bool _isSortAscending = true;
    private string _currentSortColumn = "date";
    private int _pageSize = 5;
    private int _pageNumber = 1;
    private int _totalPages;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadVehicleListDto();
        _driverListDto = await _driverService.GetAllDriversAsync();
        _isLoading = false;
    }

    private async Task LoadVehicleListDto()
    {
        _vehicleListDto = await _vehicleService.GetAllVehicleAsync(_currentSortColumn, _isSortAscending, _pageNumber, _pageSize);
        _totalPages = (int)Math.Ceiling((double)_vehicleListDto.TotalItems / _pageSize);
    }

    private void AddNewVehicle()
    {
        SetBoolDefault();

        _selectedVehicle = false;
        _addNewFuelCard = true;
    }

    private void SetBoolDefault()
    {
        _showSendConfirmation = false;
        _error = false;
    }

    private async Task SelectVehicle(VehicleDto selectedVehicle)
    {
        _selectedVehicleDto = selectedVehicle;
        _driverVehicleDtos = (await _driverVehicleService.GetVehicleWithConnectedDriversByVehicleId(_selectedVehicleDto.Id)).Item1;
        var v = _driverVehicleDtos.Select(x => _driverListDto.DriverDtos.Where(r => x.DriverId == r.Id).ToList()).ToList();
        _checkedDriver = v.SelectMany(x => x.Select(x => x).ToList()).ToList();
        _showSendConfirmation = false;
        _selectedVehicle = true;
        _addNewFuelCard = false;
        _vehicleAdded = false;
        _vehicleUpdated = false;
        _vehicleDeleted = false;
    }
}
